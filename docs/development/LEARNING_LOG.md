# Smart Weather MCP Server 實作學習日誌

## 使用說明

本檔案記錄專案實作過程中的技術發現、決策過程、問題解決方案和經驗教訓，是持續學習與改善的重要工具。

### 記錄格式

每個階段的學習記錄包含以下結構：
- **技術發現**：具體的技術行為、API 特性、最佳實作
- **決策記錄**：重要技術決策的原因和影響
- **問題解決**：遇到的問題和具體解決方案
- **效能優化**：效能調優的發現和結果
- **未來改善**：識別的改善機會和技術債務

## 學習記錄

### 2025-08-03 - 專案規劃階段

#### 技術發現
- **專案結構設計**：基於 CLAUDE.md 分析，確認專案遵循 MCP 設計哲學
- **開發原則應用**：development-principles.mdc 提供了完整的敏捷開發指導
- **風險識別方法**：透過分析技術棧複雜度識別關鍵風險

#### 決策記錄
- **決策**：採用 5 階段漸進式開發計劃
- **原因**：遵循「快速部署優先」和「小批次開發」原則，降低整合風險
- **影響**：每階段都可獨立驗證和部署，減少大規模失敗風險

#### 問題解決
- **問題**：如何平衡功能完整性與快速交付
- **解決方案**：採用 MVP 優先策略，每階段都有明確的最小可行目標
- **效果**：確保每個階段都能產生可部署的價值

#### 未來改善
- 建立自動化測試流程以支援快速迭代
- 考慮實作 A/B 測試機制驗證功能效果
- 建立更細緻的效能監控指標

---

## 階段 1: 基礎架構建立 ✅ 已完成

### 預期挑戰
- MCP SDK 與 Express.js 整合
- SSE 傳輸在 Cloud Run 環境的穩定性
- Docker 容器最佳化

### 實際學習要點 (2025-08-03)

#### 技術發現
- **MCP SDK 雙模式運行**：需要分別支援 HTTP/SSE (Claude Desktop) 和 STDIO (命令列) 兩種傳輸模式
- **TypeScript 類型安全**：MCP SDK 的參數類型需要特殊處理，使用 `as unknown as WeatherQuery` 避免類型衝突
- **Secret Manager 漸進式採用**：可以實現本地環境變數 + 生產環境 Secret Manager 的漸進式遷移
- **Express + MCP 雙伺服器架構**：HTTP REST API 和 MCP STDIO 可以共存，滿足不同客戶端需求

#### 決策記錄
- **決策**：建立 `mcp-stdio.ts` 專門處理 Claude Desktop 整合
- **原因**：Claude Desktop 需要 STDIO 傳輸，與 HTTP/SSE 服務分離更清晰
- **影響**：需要維護兩個入口點，但職責更清楚

#### 問題解決
- **問題**：TypeScript 編譯失敗，類型不匹配
- **解決方案**：使用雙重類型轉換 `args as unknown as WeatherQuery`
- **效果**：保持類型安全的同時通過編譯

- **問題**：MCP 客戶端連線測試困難
- **解決方案**：建立簡單的 JSON-RPC 測試腳本直接與 STDIO 介面通信
- **效果**：可以快速驗證 MCP 協議實作正確性

#### 效能優化
- **Secret 載入最佳化**：使用 Promise.all 並行載入多個 secrets
- **錯誤處理層級化**：環境變數 → Secret Manager → 降級處理
- **Docker 映像最佳化**：使用 node:18-slim 減少映像大小

#### 未來改善
- 考慮實作工具呼叫快取機制
- 加入更詳細的錯誤追蹤和日誌
- 建立自動化測試覆蓋 MCP 協議

### 2025-08-03 晚間更新 - 統一傳輸模式實現

#### 技術發現
- **統一伺服器架構**：成功實現單一入口點支援多種傳輸模式（STDIO、HTTP/SSE）
- **命令列參數解析**：使用 `--mode=stdio|http` 切換傳輸模式，無需重寫代碼
- **STDIO 日誌分離**：關鍵發現 - STDIO 模式需要所有日誌輸出到 stderr，避免污染 JSON-RPC stdout
- **Claude Desktop 相容性**：完美解決 Claude Desktop 的 JSON 解析錯誤問題

#### 決策記錄  
- **決策**：建立 `unified-server.ts` 取代多個入口點
- **原因**：簡化部署、提高可維護性、統一行為
- **影響**：所有環境使用相同伺服器代碼，只需調整啟動參數

#### 問題解決
- **問題**：Claude Desktop 出現 "Unexpected token 'L', 'Loading se'..." JSON 錯誤
- **解決方案**：將所有 `console.log()` 改為 `console.error()` 重定向到 stderr
- **效果**：Claude Desktop 可正常解析 JSON-RPC 訊息，工具呼叫成功

- **問題**：需要為不同用途維護多個伺服器入口點
- **解決方案**：統一伺服器 + 命令列參數模式切換
- **效果**：單一代碼庫支援所有部署場景

#### 效能優化
- **啟動時間最佳化**：統一入口點減少代碼重複，提升冷啟動速度
- **記憶體使用優化**：避免載入不需要的傳輸模組
- **部署簡化**：一個 Docker 映像支援所有模式

#### 新增功能完成
- **✅ 統一伺服器**：`npm run start:unified` 支援模式切換
- **✅ 改進的 NPM 腳本**：`dev:stdio`, `dev:http`, `start:stdio`, `start:http`
- **✅ Claude Desktop 修復**：完美支援 Claude Desktop 整合
- **✅ 完整文檔**：新增 `TRANSPORT_MODES.md` 詳細說明所有傳輸模式

#### 架構決策更新

##### 決策 005: 統一傳輸模式架構
- **日期**: 2025-08-03
- **決策**: 實現統一伺服器支援多種傳輸模式
- **原因**:
  - 降低維護複雜度
  - 統一行為和配置
  - 簡化部署流程
  - 提高代碼可重用性
- **備選方案**: 維護分離的伺服器入口點
- **影響**: 需要重構現有入口點，但大幅簡化未來維護

---

## 階段 2: Gemini AI 整合驗證

### 預期挑戰
- Gemini API 回應時間控制
- 自然語言解析準確度調優
- API 配額管理

### 學習要點 (待更新)
*此區塊將在階段 2 開始後更新*

---

## 階段 3: 天氣 API 整合

### 預期挑戰
- Google Maps Platform API 限制
- 地點歧義處理邏輯
- 資料快取策略設計

### 學習要點 (待更新)
*此區塊將在階段 3 開始後更新*

---

## 階段 4: MCP 工具實作

### 預期挑戰
- 工具間資料流設計
- 錯誤處理機制統一
- 複雜查詢場景支援

### 學習要點 (待更新)
*此區塊將在階段 4 開始後更新*

---

## 階段 5: 最佳化與部署準備

### 預期挑戰
- 生產環境效能調優
- 安全配置驗證
- 監控與告警設定

### 學習要點 (待更新)
*此區塊將在階段 5 開始後更新*

---

## 重要技術決策記錄

### 架構決策

#### 決策 001: MCP 工具限制為 3 個
- **日期**: 2025-08-03
- **決策**: 嚴格遵循 Storefront MCP 哲學，限制工具數量為 3 個
- **原因**: 
  - 簡化用戶認知負擔
  - 提高工具品質和專注度
  - 降低維護複雜度
- **備選方案**: 實作更多專門化工具
- **影響**: 需要更仔細設計工具功能範圍，確保涵蓋主要使用場景

#### 決策 002: 採用統一參數結構
- **日期**: 2025-08-03
- **決策**: 所有工具使用 `query` + `context` 參數模式
- **原因**:
  - 簡化 AI 解析邏輯
  - 提供一致的用戶體驗
  - 降低工具學習成本
- **備選方案**: 每個工具使用專門化參數
- **影響**: 需要在 Gemini 解析層做更多智能化處理

#### 決策 003: 優先 Cloud Run 部署
- **日期**: 2025-08-03
- **決策**: 以 Cloud Run 為主要部署目標，不考慮其他容器平台
- **原因**:
  - 自動擴展能力
  - 成本效益（按使用付費）
  - Google 生態系整合優勢
- **備選方案**: 支援多雲部署
- **影響**: 可以更深度整合 Google Cloud 服務，但增加平台依賴

### 技術選型決策

#### 決策 004: 使用 Gemini 2.5 Flash-Lite
- **日期**: 2025-08-03
- **決策**: 採用 Gemini 2.5 Flash-Lite 作為自然語言解析引擎
- **原因**:
  - 延遲低，適合即時查詢
  - 成本相對較低
  - Google 生態系整合佳
- **備選方案**: OpenAI GPT-4、Claude 等其他 LLM
- **影響**: 需要針對 Gemini 特性設計 prompt 和錯誤處理

---

## 問題與解決方案記錄

### 常見問題集

*此區塊將隨著實作過程更新*

---

## 效能最佳化記錄

### 最佳化機會

*此區塊將隨著效能測試結果更新*

---

## 安全性考量記錄

### 安全檢查清單

- [ ] API 金鑰安全儲存 (Secret Manager)
- [ ] 輸入驗證機制
- [ ] 輸出資料清理
- [ ] 錯誤訊息安全性
- [ ] 存取控制設定
- [ ] 日誌記錄安全性

---

## 技術債務追蹤

### 已識別的技術債務

*此區塊將隨著開發進展更新*

---

## 經驗教訓總結

### 成功實踐

*此區塊將在專案完成後更新*

### 避免重複的錯誤

*此區塊將隨著問題發現和解決更新*

### 對未來專案的建議

*此區塊將在專案結束時總結*

---

## 更新記錄

- **2025-08-03**: 初始化學習日誌檔案，建立基本結構和記錄格式
- *後續更新將記錄在此*

---

**注意事項**：
1. 每完成一個重要里程碑都應該更新此檔案
2. 技術困難和解決過程要詳細記錄
3. 所有重要決策都需要記錄原因和備選方案
4. 定期回顧並總結經驗教訓
5. 保持記錄的及時性和準確性